<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Convert</title>
   <script>
      function dodrop(event)
{
  var dt = event.dataTransfer;
  var files = dt.files;
  
    for (var i = 0; i < files.length; i++) {
      reader = new FileReader();
      reader.onload = function (event) {
        
        const input = event.target.result;
        let result = input.split('\n').map(function(s) { if (s) { return JSON.parse(s); } });

        const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
        //const header = Object.keys(result[0])
        const header = {}
        console.log(header);
        console.log(result[0]);

        const lines = [];
        
        result.forEach(function (row) { 
          const rows = [];
          console.log(row["data"]["legacy"]["full_text"]);
          //https://github.com/digitalmethodsinitiative/4cat/blob/master/datasources/twitter-import/search_twitter.py
          const body = {"id": row["rest_id"],
            "thread_id": row["data"]["legacy"]["conversation_id_str"],
            //"timestamp": timestamp.strftime("%Y-%m-%d %H:%M:%S"),
            //"unix_timestamp": int(timestamp.timestamp()),
            "link": "https://twitter.com/{row['core']['user_results']['result']['legacy']['screen_name']}/status/{row['id']}",
            "body": row["data"]["legacy"]["full_text"],
            "author": row["data"]["core"]["user_results"]["result"]["legacy"]["screen_name"],
            "author_fullname": row["data"]["core"]["user_results"]["result"]["legacy"]["name"],
            "author_id": row["data"]["legacy"]["user_id_str"],
            "source": row["source"],
            "language_guess": row["data"]["legacy"]["lang"],
            "possibly_sensitive": (row["data"]["possibly_sensitive"])? "yes" : "no",
            "retweet_count": row["data"]["legacy"]["retweet_count"],
            "reply_count": row["data"]["legacy"]["reply_count"],
            "like_count": row["data"]["legacy"]["favorite_count"],
            "quote_count": row["data"]["legacy"]["quote_count"],
            "impression_count": row["data"]["views"]["count"],
            //"is_retweet": (retweet)? "yes": "no",
            //"retweeted_user": (retweet) ? row["result"]["core"]["user_results"]["result"]["legacy"]["screen_name"]: "",
            /*"is_quote_tweet": (quote_tweet)? "yes": "no",
            "quoted_user": quote_tweet["result"]["core"]["user_results"]["result"]["legacy"][
                "screen_name"] if quote_tweet else "",
            "is_reply": "yes" if str(tweet["legacy"]["conversation_id_str"]) != str(tweet["rest_id"]) else "no",
            "replied_user": tweet["legacy"].get("in_reply_to_screen_name", ""),
            "hashtags": ",".join([hashtag["text"] for hashtag in row["legacy"]["entities"]["hashtags"]]),
            "urls": ",".join([url["expanded_url"] for url in row["legacy"]["entities"]["urls"]]),
            "images": ",".join([media["media_url_https"] for media in row["legacy"]["entities"].get("media", []) if
                                media["type"] == "photo"]),
            "videos": ",".join([media["media_url_https"] for media in row["legacy"]["entities"].get("media", []) if
                                media["type"] == "video"]),
            "mentions": row["legacy"]["entities"]["user_mentions"].join(','),*/
            "place_name": (row["legacy"]["place"])? row["legacy"]["place"]["full_name"] : ""}
          
          lines.push(rows.join(','))
        } );
        const csv = [
          header.join(','), // header row first
          lines
          //...result.map(function(row) { header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(',' ) } )
        ].join('\n')
        document.getElementById('csv').innerText = csv;
      };
      reader.readAsText(files[i]);
    }
}
   </script>
</head>
<body>

<div id="output" style="min-height: 200px; white-space: pre; border: 1px solid black;"
     ondragenter="document.getElementById('output').textContent = ''; event.stopPropagation(); event.preventDefault();"
     ondragover="event.stopPropagation(); event.preventDefault();"
     ondrop="event.stopPropagation(); event.preventDefault();
     dodrop(event);">
     DROP FILES HERE FROM FINDER OR EXPLORER
</div>
<div id="csv"></div>


</body>
</html>
